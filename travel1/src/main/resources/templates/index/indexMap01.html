<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script src="../js/jquery.min.js" type="text/javascript"></script>
    <script src="../js/echarts.min.js"></script>
    <script src="../js/china.js"></script>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="" name="description" />
    <meta content="" name="author" />
    <link href="../media/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/bootstrap-responsive.min.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/style-metro.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/style-responsive.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/default.css" rel="stylesheet" type="text/css" id="style_color"/>
    <link href="../media/css/uniform.default.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/jquery.gritter.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/daterangepicker.css" rel="stylesheet" type="text/css" />
    <link href="../media/css/fullcalendar.css" rel="stylesheet" type="text/css"/>
    <link href="../media/css/jqvmap.css" rel="stylesheet" type="text/css" media="screen"/>
    <link href="../media/css/jquery.easy-pie-chart.css" rel="stylesheet" type="text/css" media="screen"/>
    <script	src="../layer/layer.js" type="text/javascript">	</script>
    <link rel="shortcut icon" href="../media/image/favicon.ico" />

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=dWE9mgZOhKTz7Bgkeg9VAGamm9GfKMW8"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/library/CurveLine/1.5/src/CurveLine.min.js"></script>

    <script>
        $(function () {  //页面加载完成之后再执行
            //最热城市
            $.ajax({
                "url": "/CityTravelTop",
                "async": false,
                "type": "get",
                "dataType": "json",
                "success": function (rs) {
                    var content ="";
                    content += "<div class='scroller' data-height='290px' data-always-visible='1' data-rail-visible='0'>" +
                        "<ul class='feeds'>"
                    for(var i=0;i<rs.length;i++){
                        content += "<li><a href='/TravelList?city="+rs[i].city+"&currPage=1'><div class='col1'><div class='cont'><div class='cont-col1'><div class='label label-success'><i class='icon-bell'></i>"+
                            "</div></div><div class='cont-col2'><div class='desc'>"+rs[i].city+"</div></div></div></div><div class='col2'><div class='date'>"+rs[i].num+"</div></div></a></li>";
                    }
                    //拼接html  cities //feeds
                    content += "</ul></div>";
                    $("#tab_1_1").html(content);
                }
            });

            //最热景点
            $.ajax({
                "url": "/JingdianTop",
                "async": false,
                "type": "get",
                "dataType": "json",
                "success": function (rs) {
                    var content ="";
                    content += "<div class='scroller' data-height='290px' data-always-visible='1' data-rail-visible='0'>" +
                        "<ul class='feeds'>"
                    for(var i=0;i<rs.length;i++){
                        content += "<li><div class='col1'><div class='cont'><div class='cont-col1'><div class='label label-success'><i class='icon-bell'></i>"+
                            "</div></div><div class='cont-col2'><div class='desc'>"+rs[i].jingdian+"</div></div></div></div><div class='col2'><div class='date'>"+rs[i].num+"</div> </div> </li>";
                    }
                    //拼接html  cities //feeds
                    content += "</ul></div>";
                    $("#tab_1_2").html(content);


                }
            });


        })

    </script>

</head>
<div class="page-container">

    <!-- 左边菜单栏 下-->
    <div class="page-sidebar nav-collapse collapse" th:include="left.html">
    </div>
    <!-- 左边菜单栏 上-->
    <!--主体区 -->
    <div class="page-content">
        <!--主页-->
        <div class="container-fluid">
            <!--页头-->
            <div class="row-fluid">
                <div class="span12">

                    <!-- 自定义窗口 -->
                    <div class="color-panel hidden-phone">
                        <div class="color-mode-icons icon-color"></div>
                        <div class="color-mode-icons icon-color-close"></div>
                        <div class="color-mode">
                            <p>主题颜色</p>
                            <ul class="inline">
                                <li class="color-black current color-default" data-style="default"></li>
                                <li class="color-blue" data-style="blue"></li>
                                <li class="color-brown" data-style="brown"></li>
                                <li class="color-purple" data-style="purple"></li>
                                <li class="color-grey" data-style="grey"></li>
                                <li class="color-white color-light" data-style="light"></li>
                            </ul>
                            <label>
                                <span>Layout</span>
                                <select class="layout-option m-wrap small">
                                    <option value="fluid" selected>Fluid</option>
                                    <option value="boxed">Boxed</option>
                                </select>
                            </label>
                            <label>
                                <span>Header</span>
                                <select class="header-option m-wrap small">
                                    <option value="fixed">Fixed</option>
                                    <option value="default" selected>Default</option>
                                </select>
                            </label>
                            <label>
                                <span>Sidebar</span>
                                <select class="sidebar-option m-wrap small">
                                    <option value="fixed" selected >Fixed</option>
                                    <option value="default">Default</option>
                                </select>
                            </label>
                            <label>
                                <span>Footer</span>
                                <select class="footer-option m-wrap small">
                                    <option value="fixed" selected>Fixed</option>
                                    <option value="default" >Default</option>
                                </select>
                            </label>
                        </div>
                    </div>
                    <!-- 自定义窗口 -->
                    <h3 class="page-title">
                        <!--页头  仪表盘-->
                        首页 <small>statistics and more</small>
                    </h3>
                    <ul class="breadcrumb">
                        <!--当前页面的地址-->
                        <li>
                            <i class="icon-home"></i>
                            <a href="index.html">首页</a>
                            <i class="icon-angle-right"></i>
                        </li>
                        <li><a href="#">Dashboard</a></li>
                    </ul>
                </div>
            </div>
            <!-- 页头结束-->

            <div id="dashboard">
                <!-- 整个页面 -->
                <!-- 第一个大分区，里边四个小分区 -->
                <div class="row-fluid">
                    <div class="span9">
                        <div class="tabbable tabbable-custom tabbable-full-width">
                            <ul class="nav nav-tabs">
                                <li class="active"><a data-toggle="tab" href="#tab_2_2">心情图</a></li>
                                <li><a data-toggle="tab" href="#tab_2_3">路线图</a></li>
                                <li><a data-toggle="tab" href="#tab_1_4">美食游</a></li>
                                <li><a data-toggle="tab" href="#tab_1_5">User Search </a></li>
                            </ul>
                            <div class="tab-content">
                                <div id="tab_2_2" class="tab-pane active">
                                    <!-- BEGIN PORTLET-->
                                    <div class="portlet solid bordered light-grey">
                                        <div class="portlet-title">
                                            <div class="caption"><i class="icon-bar-chart"></i>全国旅游心情图</div>
                                            <div class="tools">
                                                <div class="btn-group pull-right" data-toggle="buttons-radio">
                                                    <!--<a href="" class="btn mini">Users</a>
                                                    <a href="" class="btn mini active">Feedbacks</a>-->
                                                    <select name="month" id="month" onchange="ChangeMonth()">
                                                        <option value="0">全年</option>
                                                        <option value="1">3-5月</option>
                                                        <option value="2">6-8月</option>
                                                        <option value="3">9-11月</option>
                                                        <option value="4">12-2月</option>
                                                    </select>

                                                </div>
                                            </div>
                                        </div>

                                        <div class="portlet-body">
                                            <!--加载地图 class="span9"-->
                                            <div id="main" style="width:100%;height:500px;background-color: #f5f6f0"></div>
                                        </div>
                                    </div>
                                    <!-- END PORTLET-->
                                </div>
                                <div id="tab_2_3" class="tab-pane">
                                    <!-- BEGIN PORTLET-->
                                    <div class="portlet solid bordered light-grey">
                                        <div class="portlet-title">
                                            <div class="caption"><i class="icon-bar-chart"></i>全国热门旅游路线</div>

                                            <div class="tools">
                                                <div class="btn-group pull-right" data-toggle="buttons-radio">
                                                    <!--<a href="" class="btn mini">Users</a>
                                                    <a href="" class="btn mini active">Feedbacks</a>-->
                                                    <select name="month" id="month1">
                                                        <option value="0">全年</option>
                                                        <option value="1">3-5月</option>
                                                        <option value="2">6-8月</option>
                                                        <option value="3">9-11月</option>
                                                        <option value="4">12-2月</option>
                                                    </select>
                                                    <input type="text" name="city" id="city" placeholder="起点城市" />
                                                    <button type="button" id="chaxun" onclick="chaxun()">查询</button>
                                                </div>

                                            </div>
                                        </div>

                                        <div class="portlet-body">
                                            <!--加载地图 class="span9"  background-color: #f5f6f0-->
                                            <div id="allmap" style="width:100%;height:500px;"></div>
                                        </div>
                                    </div>
                                    <!-- END PORTLET-->
                                </div>
                                <!--下一个分页-->
                            </div>
                        </div>
                    </div>
                    <div class="span3">
                        <!-- BEGIN PORTLET-->
                        <div class="portlet paddingless">
                            <div class="portlet-title line">
                                <div class="caption"><i class="icon-bell"></i>热门排行</div>
                                <div class="tools">
                                    <a href="" class="collapse"></a>
                                    <a href="#portlet-config" data-toggle="modal" class="config"></a>
                                    <a href="" class="reload"></a>

                                </div>
                            </div>
                            <div class="portlet-body">
                                <!--BEGIN TABS-->
                                <div class="tabbable tabbable-custom">
                                    <ul class="nav nav-tabs">
                                        <li class="active"><a href="#tab_1_1" data-toggle="tab">最热城市</a></li>
                                        <li><a href="#tab_1_2" data-toggle="tab">热门景点</a></li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane active" id="tab_1_1"></div>
                                        <div class="tab-pane" id="tab_1_2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="clearfix"></div>
                </div>
            </div>
        </div>
        <!-- 页 -->
    </div>
    <div class="footer">
        <div class="footer-tools">
			<span class="go-top">
			<i class="icon-angle-up"><font size="3">回到顶部</font></i>
			</span>
        </div>
    </div>
</div>


<!-- 底部 -->

<!-- JS -->
<script src="../media/js/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
<script src="../media/js/jquery-ui-1.10.1.custom.min.js" type="text/javascript"></script>
<script src="../media/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../media/js/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="../media/js/jquery.blockui.min.js" type="text/javascript"></script>
<script src="../media/js/jquery.cookie.min.js" type="text/javascript"></script>
<script src="../media/js/jquery.uniform.min.js" type="text/javascript" ></script>
<script src="../media/js/jquery.vmap.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.russia.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.world.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.europe.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.germany.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.usa.js" type="text/javascript"></script>
<script src="../media/js/jquery.vmap.sampledata.js" type="text/javascript"></script>
<script src="../media/js/jquery.flot.js" type="text/javascript"></script>
<script src="../media/js/jquery.flot.resize.js" type="text/javascript"></script>
<script src="../media/js/jquery.pulsate.min.js" type="text/javascript"></script>
<script src="../media/js/date.js" type="text/javascript"></script>
<script src="../media/js/daterangepicker.js" type="text/javascript"></script>
<script src="../media/js/jquery.gritter.js" type="text/javascript"></script>
<script src="../media/js/fullcalendar.min.js" type="text/javascript"></script>
<script src="../media/js/jquery.easy-pie-chart.js" type="text/javascript"></script>
<script src="../media/js/jquery.sparkline.min.js" type="text/javascript"></script>
<script src="../media/js/app.js" type="text/javascript"></script>
<script src="../media/js/index.js" type="text/javascript"></script>

<!-- END PAGE LEVEL SCRIPTS -->

<script>
    jQuery(document).ready(function() {
        App.init(); // initlayout and core plugins
        Index.init();
        Index.initChat();
        Index.initMiniCharts();
        Index.initDashboardDaterange();
    });

    function ChangeMonth(){
        var month = document.getElementById("month").value;
        alert(month)
        mapLoad(month)
    }

    $(function () {
        mapLoad(0)
    })

    function mapLoad(kind) {
        var myChart = echarts.init(document.getElementById('main'));
        //各省份的地图json文件
        var provinces = {
            '上海': '../datajson/data-1482909900836-H1BC_1WHg.json',
            '河北': '../datajson/data-1482909799572-Hkgu_yWSg.json',
            '山西': '../datajson/data-1482909909703-SyCA_JbSg.json',
            '内蒙古': '../datajson/data-1482909841923-rkqqdyZSe.json',
            '辽宁': '../datajson/data-1482909836074-rJV9O1-Hg.json',
            '吉林': '../datajson/data-1482909832739-rJ-cdy-Hx.json',
            '黑龙江': '../datajson/data-1482909803892-Hy4__J-Sx.json',
            '江苏': '../datajson/data-1482909823260-HkDtOJZBx.json',
            '浙江': '../datajson/data-1482909960637-rkZMYkZBx.json',
            '安徽': '../datajson/data-1482909768458-HJlU_yWBe.json',
            '福建': '../datajson/data-1478782908884-B1H6yezWe.json',
            '江西': '../datajson/data-1482909827542-r12YOJWHe.json',
            '山东': '../datajson/data-1482909892121-BJ3auk-Se.json',
            '河南': '../datajson/data-1482909807135-SJPudkWre.json',
            '湖北': '../datajson/data-1482909813213-Hy6u_kbrl.json',
            '湖南': '../datajson/data-1482909818685-H17FOkZSl.json',
            '广东': '../datajson/data-1482909784051-BJgwuy-Sl.json',
            '广西': '../datajson/data-1482909787648-SyEPuJbSg.json',
            '海南': '../datajson/data-1482909796480-H12P_J-Bg.json',
            '四川': '../datajson/data-1482909931094-H17eKk-rg.json',
            '贵州': '../datajson/data-1482909791334-Bkwvd1bBe.json',
            '云南': '../datajson/data-1482909957601-HkA-FyWSx.json',
            '西藏': '../datajson/data-1482927407942-SkOV6Qbrl.json',
            '陕西': '../datajson/data-1482909918961-BJw1FyZHg.json',
            '甘肃': '../datajson/data-1482909780863-r1aIdyWHl.json',
            '青海': '../datajson/data-1482909853618-B1IiOyZSl.json',
            '宁夏': '../datajson/data-1482909848690-HJWiuy-Bg.json',
            '新疆': '../datajson/data-1482909952731-B1YZKkbBx.json',
            '北京': '../datajson/data-1482818963027-Hko9SKJrg.json',
            '天津': '../datajson/data-1482909944620-r1-WKyWHg.json',
            '重庆': '../datajson/data-1482909775470-HJDIdk-Se.json',
            '香港': '../datajson/data-1461584707906-r1hSmtsx.json',
            '澳门': '../datajson/data-1482909771696-ByVIdJWBx.json'
        };
        //地图中的地点 经纬度和名称
        var geoCoordMap = { //为了保证饼图不互相重叠，我对经纬坐标进行了调整
            '上海':  [121.472644,  31.231706],
            '云南':  [102.712251,  24.040609],
            '内蒙古':  [111.670801,  40.818311],
            '北京':  [116.405285,  39.904989],
            '台湾': [121.509062, 25.044332],
            '吉林':  [125.3245,  43.886841],
            '四川':  [103.065735,  30.659462],
            '天津':  [119.190182,  39.125596],
            '宁夏':  [106.278179,  38.46637],
            '安徽':  [117.283042,  31.86119],
            '山东':  [118.000923,  36.675807],
            '山西':  [112.049248,  37.057014],
            '广东':  [113.280637,  23.125178],
            '广西':  [108.320004,  22.82402],
            '新疆':  [87.617733,  43.792818],
            '江苏':  [119.467413,  33.741544],
            '江西':  [115.892151,  28.676493],
            '河北':  [114.802461,  37.745474],
            '河南':  [113.665412,  33.757975],
            '浙江':  [120.153576,  29.287459],
            '海南':  [110.33119,  20.031971],
            '湖北':  [113.298572,  30.984355],
            '湖南':  [112.12279,  28.19409],
            // '澳门': [113.54909, 22.198951],
            '甘肃':  [103.823557,  36.058039],
            '福建':  [119.306239,  26.075302],
            '西藏':  [91.132212,  29.660361],
            '贵州':  [106.713478,  26.578343],
            '辽宁':  [123.029096,  41.396767],
            '重庆':  [106.504962,  29.933155],
            '陕西':  [108.948024,  34.263161],
            '青海':  [100.578916,  36.623178],
            // '香港': [114.173355, 22.320048],
            '黑龙江':  [126.642464,  46.756967],
        }
        var typeIndex = 1;
        var nametext = "定制地图区域饼图数据统计";
        var data = [];

        //初始化全国地图
        loadMap('../datajson/data-1527045631990-r1dZ0IM1X.json', 'china',kind);

        var timeFn = null;
        //单击切换到省级地图，当mapCode有值,说明可以切换到下级地图
        myChart.on('click', function(params) {
            clearTimeout(timeFn);
            //由于单击事件和双击事件冲突，故单击的响应事件延迟250毫秒执行
            timeFn = setTimeout(function() {
                var name = params.name; //地区name
                console.log("点击事件参数："+name)
                var mapCode = provinces[name]; //地区的json数据
                console.log("根据参数，获得mapCode："+mapCode)
                if (!mapCode) {
                    alert('无此区域地图显示');
                    return;
                }
                //如果获得mapCode,加载地图
                loadMap(mapCode, name,0);
            }, 250);
        });
        // 绑定双击事件，返回全国地图
        myChart.on('dblclick', function(params) {
            //当双击事件发生时，清除单击事件，仅响应双击事件
            clearTimeout(timeFn);
            //返回全国地图
            loadMap('../datajson/data-1527045631990-r1dZ0IM1X.json', 'china',kind);
        });

        /**
         获取对应的json地图数据，然后向echarts注册该区域的地图，最后加载地图信息
         @params {String} mapCode:json数据的地址
         @params {String} name: 地图名称
         */
        function loadMap(mapCode, name,kind) {
            if(name == 'china'){
                data = [];
                console.log("全国")
                var max = 0;//总量的最大值
                var mapdata1 = [];
                $.get(mapCode, function(geoJson) {
                    var option = null;
                    echarts.registerMap(name, geoJson);
                    echarts.getMap(name).geoJson.features;

                    //Ajax获取每个省份的好的，差的，一般的个数，总数相加，进行赋值
                    $.ajax({
                        "url": "/provinceNum",
                        //"data":{"kind":kind},//季度
                        "async": false,
                        "type": "get",
                        "dataType": "json",
                        "success": function (rs) {
                            // alert("长度："+rs.length)
                            if (null != rs && "" != rs) {
                                for(var i=0;i<rs.length;i++){
                                    provincename = rs[i].province;
                                    if(kind == 0){
                                        //alert("kind:"+kind)
                                        haonum = rs[i].haonum; //省总的好游记数
                                        normalnum = rs[i].normalnum; //省总的一般游记数
                                        badnum = rs[i].badnum; //省总的差游记数
                                        num = haonum + normalnum + badnum; //省总的游记数
                                    }else if(kind == 1){
                                        haonum = rs[i].haonum1;
                                        normalnum = rs[i].normalnum1; //省3-5月的一般游记数
                                        badnum = rs[i].badnum2; //省3-5月的差游记数
                                        num = haonum + normalnum + badnum; //省3-5月的游记数
                                    }else if(kind == 2){
                                        haonum = rs[i].haonum2;
                                        normalnum = rs[i].normalnum2; //省6-8月的一般游记数
                                        badnum = rs[i].badnum1; //省6-8月的差游记数
                                        num = haonum + normalnum + badnum; //省3-5月的游记数

                                    }else if(kind == 3){
                                        haonum = rs[i].haonum3;
                                        normalnum = rs[i].normalnum3; //省9-11月的一般游记数
                                        badnum = rs[i].badnum3; //省9-11月的差游记数
                                        num = haonum + normalnum + badnum; //省9-11月的游记数
                                    }else if(kind == 4){
                                        haonum = rs[i].haonum4;
                                        normalnum = rs[i].normalnum4; //省12-2月的一般游记数
                                        badnum = rs[i].badnum4; //省12-2月的差游记数
                                        num = haonum + normalnum + badnum; //省12-2月的游记数
                                    }
                                    data.push({  //data的数量也是饼图的数量
                                        // 需要挨个处理各地区数据（不使用随机产生的数）：另外需要构造的数据是柱图数据
                                        "name": provincename,
                                        "value": [
                                            {name: "满意",value: haonum},
                                            {name: "一般",value: normalnum},
                                            {name: "差",value : badnum},
                                        ]
                                    })
                                    //总量
                                    mapdata1.push({
                                        name: provincename,
                                        value: num
                                    })
                                    //找到最多的总量，将其作为颜色的最高
                                    if(num > max)
                                        max = num;
                                }


                            }
                        }
                    });
                    /*addPie*/
                    function addPie(chart, data) {
                        console.log("画饼图。。。")
                        var op = chart.getOption();
                        var sd = option.series;

                        for (var i = 0; i < data.length; i++) {
                            var randomValue = 10;
                            var radius = randomValue;
                            var geoCoord = geoCoordMap[data[i].name];
                            if (geoCoord) {
                                var vr = [];
                                (data[i].value).map(function(v, j) {
                                    vr.push({
                                        name: v.name,
                                        value: v.value,
                                        visualMap:false
                                    });
                                });
                                var p = chart.convertToPixel({
                                    seriesIndex: 0
                                }, geoCoord);
                                sd.push({
                                    name: data[i].name,
                                    type: 'pie',
                                    tooltip: {
                                        formatter: function(params) {
                                            return params.seriesName + "<br/>" + params.name + " : " + params.value+'';
                                        }
                                    },
                                    radius: radius,
                                    center: p,
                                    data: vr,
                                    // zlevel:1,
                                    label: {
                                        normal: {
                                            show: false,
                                        },
                                    },
                                    labelLine: {
                                        normal: {
                                            show: false
                                        }
                                    },
                                    itemStyle: {
                                        mormal: {
                                            opacity: 0.1
                                        }
                                    }
                                });
                            }
                        }
                        return sd;
                    };
                    /* 指定图表的配置项和数据:pie*/
                    var option = {
                        title: {
                            text: nametext,
                            left: 'center',
                            textStyle: {
                                color: 'black'
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function(params) {
                                if (params.value) {
                                    return params.name + "<br/>" + '热度' +
                                        ": " + params.value ; //总游记数
                                }
                            }
                        },
                        visualMap: {
                            type: 'continuous',
                            show: true,
                            min: 0,
                            max: max,
                            left: 'left',
                            top: 'bottom',
                            text: ['高    (热度)', '低    (热度)'], // 文本，默认为数值文本
                            calculable: true,
                            seriesIndex: [0],
                            inRange: {
                                color:['lightskyblue','yellow','orangered']
                            }
                        },
                        series: [{
                            name: 'chinaMap',
                            type: 'map',
                            mapType: name,
                            roam: true,
                            zoom:1.5,
                            label: {
                                normal: { show: true,color: 'black',fontSize: 13},
                                emphasis: { show: true }
                            },
                            data: mapdata1 //总游记数 convertMapDta(typeArr[typeIndex],data)      //mapdata1 //convertMapDta(typeArr[typeIndex],data),
                        }]
                    };
                    if (option && typeof option === "object") {
                        myChart.setOption(option, true);
                    }
                    /*pie*/
                    addPie(myChart, data);
                    myChart.setOption(option, true);
                    /*饼图跟着地图移动:pie*/
                    myChart.on('georoam', function(params) {
                        resetPie(myChart, params, geoCoordMap, typeIndex);
                    });
                    myChart.on('datarangeselected', function(params) {
                        resetPie(myChart, params, geoCoordMap, typeIndex);
                    });
                    window.addEventListener("resize", function() {
                        myChart.resize();
                        resetPie(myChart, 0, geoCoordMap);
                    })
                    console.log("option"+option)
                    myChart.setOption(option);
                })
            }
            else{
                // 需要给各个市统计每个市的前5个景点，并按照点进行显示
                var data2 = [];
                var data3 = [];
                data = [];
                var geoCoordMap1 = [];
                myChart.setOption({series:[]},true);

                console.log("地方："+name)  //四川
                // /proJingdian  //根据ajax获取每个省的前十景点
                var mapData = [];

                $.get(mapCode, function(geoJson) {
                    var option11 ;
                    echarts.registerMap(name, geoJson);
                    var mapFeatures = echarts.getMap(name).geoJson.features;

                    var cities = [];
                    mapFeatures.forEach(function(v) {
                        // 地区名称
                        var name = v.properties.name;
                        cities.push(name)

                        console.log("地名："+name)

                        var s1 = Math.round(Math.random() * 100 + 10);
                        //各个地区的数量
                        data2.push({
                            // 需要挨个处理各地区数据（不使用随机产生的数）：另外需要构造的数据是柱图数据
                            "name": name,
                            "value": s1, //地图上的每个地区的值
                        })
                    });
                    //找到每个市的前5景点
                    $.ajax({
                        "url": "/cityJingdian",
                        "data":{"cities":cities},
                        "async": false,
                        "type": "get",
                        "dataType": "json",
                        "success": function (rs) {
                            alert("长度："+rs.length)
                            for(var i=0;i<rs.length;i++){
                                jingdian = rs[i].jingdian;
                                lng = rs[i].lng;
                                lat = rs[i].lat;
                                jingdiannum = rs[i].num;

                                //alert("景点："+jingdian+" 数量"+jingdiannum)
                                mapData[jingdian] = [lng,lat];
                                console.log("lng: "+lng+"  lat:"+lat)
                                data3.push({
                                    "name": jingdian,
                                    "value": jingdiannum, //气泡提示的值
                                })
                            }
                        }
                    });

                    // 变换地图数据（格式）：每个点上的值
                    var convertData1 = function(data) {
                        var res = [];
                        for (var i = 0; i < data.length; i++) {
                            var geoCoord = mapData[data[i].name]//geoCoordMap1[data[i].name];
                            if (geoCoord) {
                                res.push({
                                    name: data[i].name, //景点名
                                    value: geoCoord.concat(data[i].value) //景点值
                                });
                            }
                        }
                        return res;
                    };

                    /* 指定图表的配置项和数据:pie*/
                    option11 = {
                        title: {
                            text: name+"热门景点分布图",
                            subtext: '',
                            x: 'center',
                            textStyle: {
                                color: '#ccc'
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: function (params) {
                                if(typeof(params.value)[2] == "undefined"){
                                    return params.name + ' : ' + params.value;
                                }else{
                                    return params.name + ' : ' + params.value[2];
                                }
                            }
                        },
                        legend: {
                            orient: 'vertical',
                            y: 'bottom',
                            x: 'right',
                            data: ['credit_pm2.5'],
                            textStyle: {
                                color: '#fff'
                            }
                        },
                        visualMap: {
                            show: false,
                            min: 0,
                            max: 100,
                            left: 'left',
                            top: 'bottom',
                            text: ['高', '低'], // 文本，默认为数值文本
                            calculable: true,
                            seriesIndex: [0],  //指定series中哪个图根据数量变化颜色
                            inRange: {
                                color:['lightskyblue','yellow','orangered']
                            }
                        },
                        geo: {
                            show: true,
                            map: name,
                            label: {
                                normal: {
                                    show: false
                                },
                                emphasis: {
                                    show: false,
                                }
                            },
                            roam: true,
                            itemStyle: {
                                normal: {
                                    areaColor: '#031525',
                                    borderColor: '#3B5077',
                                },
                                emphasis: {
                                    areaColor: '#2B91B7',
                                }
                            }
                        },
                        series : [
                            {
                                type: 'map',
                                map: name,
                                geoIndex: 0,
                                aspectScale: 0.75, //长宽比
                                //zoom:2,
                                showLegendSymbol: false, // 存在legend时显示
                                label: {
                                    show: false,
                                    normal: {
                                        show: false
                                    },
                                    emphasis: {
                                        show: false,
                                        textStyle: {
                                            color: '#fff'
                                        }
                                    }
                                },
                                roam: true,
                                itemStyle: {
                                    normal: {
                                        areaColor: '#031525',
                                        borderColor: '#3B5077',
                                    },
                                    emphasis: {
                                        areaColor: '#2B91B7'
                                    }
                                },
                                animation: false,
                                data: data2  //convertData1(data3) //data2 //每个点的值  ,地图中，每个市的值，有关地区的颜色
                            },
                            {   //气泡
                                name: '点',
                                type: 'scatter',
                                coordinateSystem: 'geo',
                                symbol: 'pin', //气泡
                                symbolSize: 50,
                                //},
                                label: {
                                    normal: {
                                        show: true, //true //气泡上是否显示值
                                        formatter: function(params) {
                                            return params.data.value[2] //气泡上显示的值
                                        },
                                        textStyle: {
                                            color: '#fff',
                                            fontSize: 9,
                                        }
                                    }
                                },
                                itemStyle: {
                                    normal: {
                                        color: '#F62157', //标志颜色
                                    }
                                },
                                zlevel: 6,
                                data: convertData1(data3), //显示每个点上的值
                            },
                        ]
                    };
                    myChart.setOption(option11);
                });
            }
        }


        /*resetPie*/
        function resetPie(myChart, params, geoCoordMap, typeIndex) {
            var op = myChart.getOption();
            var ops = op.series;
            ops.forEach(function(v, i) {
                if (i > 0) {
                    var geoCoord = geoCoordMap[v.name];
                    var p = myChart.convertToPixel({
                        seriesIndex: 0
                    }, geoCoord);
                    v.center = p;
                    if (params != 0 && params.zoom) {
                        v.radius = v.radius * params.zoom;
                    }
                    if (params != 0 && params.selected) {
                        var rangeFirstNumber = params.selected[0];
                        var rangeSecondNumber = params.selected[1];
                        var pd = v.data[typeIndex].value;
                        if (pd < rangeFirstNumber || pd > rangeSecondNumber) {
                            v.itemStyle.normal.opacity = 0;
                        } else {
                            v.itemStyle.normal.opacity = 1;
                        }
                    }
                }
            });
            myChart.setOption(op, true);
        }
    }
</script>

</body>

<script type="text/javascript">
    $(function () {
        map(0,"");
        /*// 百度地图API功能
        var opts = {
            width : 250,     // 信息窗口宽度
            height: 80,     // 信息窗口高度
            title : "信息窗口" , // 信息窗口标题
            enableMessage:true//设置允许信息窗发送短息
        };
        $.ajax({//获取每个季节最热门的景点
            "url": "/JingdianTop", //JingdianTop //articleJing
            //"data":{"city":city},
            "async": false,
            "type": "get",
            "dataType": "json",
            "success": function (data) {
                arr = data;
                //百度地图
                var map = new BMap.Map("allmap");    // 创建Map实例
                var point11 = new BMap.Point(arr[0].lng,arr[0].lat);
                alert("中心点"+arr[0].lng+"..."+arr[0].lat)
                map.centerAndZoom(point11,5); // 初始化地图,设置中心点坐标和地图级别
                map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
                //获取文章中的出现的景点，并找出他们的经纬度
                var arr1 = new Array();
                if (null != data && "" != data) {
                    for(var i=0; i<arr.length;i++){
                        //将这些对象属性放到集合中
                        var lng = arr[i].lng;
                        var lat = arr[i].lat;
                        var num = arr[i].num;
                        //alert("lng:"+lng+" lat:"+lat);
                        var jingdian1 = arr[i].jingdian;
                        var point = new BMap.Point(lng,lat);
                        arr1.push(point);

                        var marker = new BMap.Marker(point);  // 创建标注
                        var content = "景点："+jingdian1+" 热度："+num+" 满意度："+10;
                        map.addOverlay(marker);               // 将标注添加到地图中
                        addClickHandler(content,marker,map);
                    }

                    var polyline = new BMap.Polyline(arr1,
                        {strokeColor:"red", strokeWeight:4, strokeOpacity:3});   //创建折线
                    map.addOverlay(polyline);   //增加折线
                } else {
                    alert("无景点")
                }
            }
        });

        function addClickHandler(content,marker,map){
            marker.addEventListener("click",function(e){
                openInfo(content,e,map)}
            );
        }
        function openInfo(content,e,map){
            var p = e.target;
            var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
            var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
            map.openInfoWindow(infoWindow,point); //开启信息窗口
        }*/
    })
    
    function map(month,city) {
        // 百度地图API功能
        var opts = {
            width : 250,     // 信息窗口宽度
            height: 80,     // 信息窗口高度
            title : "信息窗口" , // 信息窗口标题
            enableMessage:true//设置允许信息窗发送短息
        };
        $.ajax({//获取每个季节最热门的景点
            "url": "/JingdianTop", //JingdianTop //articleJing
            "data":{"city":city,"month":month},
            "async": false,
            "type": "get",
            "dataType": "json",
            "success": function (data) {
                arr = data;
                //百度地图
                var map = new BMap.Map("allmap");    // 创建Map实例
                var point11 = new BMap.Point(arr[0].lng,arr[0].lat);
                alert("中心点"+arr[0].lng+"..."+arr[0].lat)
                map.centerAndZoom(point11,5); // 初始化地图,设置中心点坐标和地图级别
                map.enableScrollWheelZoom(true);     //开启鼠标滚轮缩放
                //获取文章中的出现的景点，并找出他们的经纬度
                var arr1 = new Array();
                if (null != data && "" != data) {
                    for(var i=0; i<arr.length;i++){
                        //将这些对象属性放到集合中
                        var lng = arr[i].lng;
                        var lat = arr[i].lat;
                        var num = arr[i].num;
                        //alert("lng:"+lng+" lat:"+lat);
                        var jingdian1 = arr[i].jingdian;
                        var point = new BMap.Point(lng,lat);
                        arr1.push(point);

                        var marker = new BMap.Marker(point);  // 创建标注
                        map.addOverlay(marker);

                        if(city == 0 && i == 0){//肯定第一个是景点
                            var content = "起点景点："+jingdian1+" 热度："+num+" 满意度："+10;
                            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
                        }else if(city != 0 && i == 0 ){//肯定是起点
                            var content = "起点："+city;
                            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画
                        }else {
                            var content = "景点："+jingdian1+" 热度："+num+" 满意度："+10;
                        }


                        /*var curve = new BMapLib.CurveLine(arr1,
                        {strokeColor:"blue", strokeWeight:3, strokeOpacity:0.5}); //创建弧线对象
                    map.addOverlay(curve); //添加到地图中*/


                       /* if(i==0){
                            if(city == 0)
                                var content = "起点："+city;
                            else
                            map.addOverlay(marker);
                            marker.setAnimation(BMAP_ANIMATION_BOUNCE); //跳动的动画

                        }else{
                            var content = "景点："+jingdian1+" 热度："+num+" 满意度："+10;
                            map.addOverlay(marker);
                        }*/

                                      // 将标注添加到地图中
                        addClickHandler(content,marker,map);
                    }

                    var polyline = new BMap.Polyline(arr1,
                        {strokeColor:"red", strokeWeight:4, strokeOpacity:3});   //创建折线
                    map.addOverlay(polyline);   //增加折线
                } else {
                    alert("无景点")
                }
            }
        });

        function addClickHandler(content,marker,map){
            marker.addEventListener("click",function(e){
                openInfo(content,e,map)}
            );
        }
        function openInfo(content,e,map){
            var p = e.target;
            var point = new BMap.Point(p.getPosition().lng, p.getPosition().lat);
            var infoWindow = new BMap.InfoWindow(content,opts);  // 创建信息窗口对象
            map.openInfoWindow(infoWindow,point); //开启信息窗口
        }
    }
    
    function chaxun() {
        var month = $("#month1").val();
        var city =  $("#city").val();
        alert(month+","+city);
        map(month,city);
    }
    
</script>
</html>